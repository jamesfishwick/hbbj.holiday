name: Verify Netlify Deployment

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  verify-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Get commit info
        id: commit
        run: |
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "short_sha=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          echo "ğŸ“ Commit: $(echo ${{ github.sha }} | cut -c1-7)"

      - name: Wait for Netlify to receive webhook
        run: |
          echo "â³ Waiting for Netlify to start deployment..."
          sleep 15

      - name: Poll deployment status
        id: poll
        timeout-minutes: 8
        run: |
          SITE_ID="894eedac-f1b5-4686-9fc1-702429c02b78"
          COMMIT_SHA="${{ steps.commit.outputs.short_sha }}"

          echo "ğŸ” Looking for deployment of commit: $COMMIT_SHA"

          # Poll every 15 seconds for up to 8 minutes (32 attempts)
          for i in {1..32}; do
            # Get all recent deploys
            deploys=$(curl -s "https://api.netlify.com/api/v1/sites/${SITE_ID}/deploys")

            # Find deploy matching our commit
            deploy_state=$(echo "$deploys" | jq -r --arg commit "$COMMIT_SHA" \
              '.[] | select(.commit_ref | startswith($commit)) | .state' | head -1)

            deploy_id=$(echo "$deploys" | jq -r --arg commit "$COMMIT_SHA" \
              '.[] | select(.commit_ref | startswith($commit)) | .id' | head -1)

            if [ -z "$deploy_state" ]; then
              echo "â³ Deployment not found yet (attempt $i/32)"
              sleep 15
              continue
            fi

            echo "ğŸ“Š Deploy ID: $deploy_id"
            echo "ğŸ“Š Deploy State: $deploy_state (attempt $i/32)"

            case "$deploy_state" in
              "ready")
                echo "âœ… Deployment successful!"
                echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT
                echo "state=ready" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "error"|"failed")
                echo "âŒ Deployment failed with state: $deploy_state"
                echo "deploy_id=$deploy_id" >> $GITHUB_OUTPUT
                echo "state=$deploy_state" >> $GITHUB_OUTPUT

                # Get error details
                deploy_details=$(curl -s "https://api.netlify.com/api/v1/deploys/${deploy_id}")
                error_msg=$(echo "$deploy_details" | jq -r '.error_message // "No error message available"')
                echo "Error: $error_msg"
                exit 1
                ;;
              "building"|"processing"|"enqueued"|"new")
                echo "â³ Deploy in progress: $deploy_state"
                sleep 15
                ;;
              *)
                echo "âš ï¸  Unknown state: $deploy_state"
                sleep 15
                ;;
            esac
          done

          echo "âŒ Timeout: Deployment did not complete within 8 minutes"
          exit 1

      - name: Verify site is accessible
        run: |
          echo "ğŸŒ Checking if site is accessible..."

          # Check if site returns 200
          status=$(curl -s -o /dev/null -w "%{http_code}" https://hbbj.holiday)

          if [ "$status" -eq 200 ]; then
            echo "âœ… Site is accessible (HTTP $status)"
          else
            echo "âŒ Site returned HTTP $status"
            exit 1
          fi

      - name: Verify content
        run: |
          echo "ğŸ“„ Verifying site content..."

          # Check if site contains expected content
          content=$(curl -s https://hbbj.holiday)

          if echo "$content" | grep -q "Happy Birthday Baby Jesus"; then
            echo "âœ… Site content verified"
          else
            echo "âŒ Expected content not found"
            exit 1
          fi

      - name: Check build performance
        if: success()
        run: |
          echo "ğŸ“Š Deployment Performance Summary:"

          SITE_ID="894eedac-f1b5-4686-9fc1-702429c02b78"
          DEPLOY_ID="${{ steps.poll.outputs.deploy_id }}"

          deploy_details=$(curl -s "https://api.netlify.com/api/v1/deploys/${DEPLOY_ID}")

          deploy_time=$(echo "$deploy_details" | jq -r '.deploy_time')
          created_at=$(echo "$deploy_details" | jq -r '.created_at')
          published_at=$(echo "$deploy_details" | jq -r '.published_at')

          echo "Build Time: ${deploy_time}s"
          echo "Started: $created_at"
          echo "Published: $published_at"

      - name: Deployment success notification
        if: success()
        run: |
          echo "ğŸ‰ Deployment verification completed successfully!"
          echo "ğŸ”— Site: https://hbbj.holiday"
          echo "ğŸ“ Commit: ${{ steps.commit.outputs.short_sha }}"
          echo "ğŸ†” Deploy ID: ${{ steps.poll.outputs.deploy_id }}"

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "ğŸ’¥ Deployment verification failed!"
          echo "ğŸ“ Commit: ${{ steps.commit.outputs.short_sha }}"
          if [ -n "${{ steps.poll.outputs.deploy_id }}" ]; then
            echo "ğŸ†” Deploy ID: ${{ steps.poll.outputs.deploy_id }}"
            echo "ğŸ”— Netlify logs: https://app.netlify.com/sites/hbbj-holiday/deploys/${{ steps.poll.outputs.deploy_id }}"
          fi
          echo "Check the logs above for details."
          exit 1
